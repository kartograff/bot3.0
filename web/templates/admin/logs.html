{% extends "base.html" %}

{% block content %}
<div class="notion-page-header">
    <h1>
        <span class="icon">üìã</span>
        –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
    </h1>
    <div class="notion-page-description">
        –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∏ -->
<div class="tabs">
    <a href="{{ url_for('logs.logs_page', tab='recent', page=1) }}" class="tab {% if active_tab == 'recent' %}active{% endif %}">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏</a>
    <a href="{{ url_for('logs.logs_page', tab='stats') }}" class="tab {% if active_tab == 'stats' %}active{% endif %}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
</div>

{% if active_tab == 'recent' %}
<div class="notion-block filters-block">
    <div class="notion-block-body">
        <form method="get" class="filters-form">
            <input type="hidden" name="tab" value="recent">
            <div class="filter-group">
                <label class="notion-label">–£—Ä–æ–≤–µ–Ω—å</label>
                <select name="level" class="notion-input">
                    <option value="">–í—Å–µ</option>
                    <option value="ERROR" {% if level == 'ERROR' %}selected{% endif %}>ERROR</option>
                    <option value="CRITICAL" {% if level == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    <option value="WARNING" {% if level == 'WARNING' %}selected{% endif %}>WARNING</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="notion-label">–ü–æ–∏—Å–∫</label>
                <input type="text" name="search" value="{{ search }}" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="notion-input">
            </div>
            <div class="filter-actions">
                <button type="submit" class="notion-button notion-button-primary">
                    <i data-feather="filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <a href="{{ url_for('logs.logs_page', tab='recent') }}" class="notion-button">
                    <i data-feather="x"></i> –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-body">
        {% if logs %}
        <table class="notion-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–£—Ä–æ–≤–µ–Ω—å</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.id }}</td>
                    <td>
                        {% if log.level == 'ERROR' %}
                            <span class="notion-badge notion-badge-danger">ERROR</span>
                        {% elif log.level == 'CRITICAL' %}
                            <span class="notion-badge" style="background: #dc3545; color: white;">CRITICAL</span>
                        {% elif log.level == 'WARNING' %}
                            <span class="notion-badge notion-badge-warning">WARNING</span>
                        {% endif %}
                    </td>
                    <td>{{ log.created_at|datetime }}</td>
                    <td>{{ log.source }}</td>
                    <td>{{ log.user_id or '‚Äî' }}</td>
                    <td>{{ log.message|truncate(100) }}</td>
                    <td class="actions">
                        <button class="notion-button" onclick="viewLog({{ log.id }})">
                            <i data-feather="eye"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, total_pages + 1) %}
                <a href="{{ url_for('logs.logs_page', tab='recent', page=p, level=level, search=search) }}" 
                   class="notion-button {% if p == page %}notion-button-primary{% endif %}">
                    {{ p }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
        {% else %}
        <p class="empty-state">–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if active_tab == 'stats' %}
<div class="notion-block">
    <div class="notion-block-header">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫</h2>
    </div>
    <div class="notion-block-body">
        <table class="notion-table">
            <thead>
                <tr>
                    <th>–¢–∏–ø –æ—à–∏–±–∫–∏</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–í–ø–µ—Ä–≤—ã–µ</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in error_stats %}
                <tr>
                    <td>{{ stat.error_type }}</td>
                    <td>{{ stat.count }}</td>
                    <td>{{ stat.first_seen|datetime }}</td>
                    <td>{{ stat.last_seen|datetime }}</td>
                    <td>
                        {% if stat.resolved %}
                            <span class="notion-badge notion-badge-success">–†–µ—à–µ–Ω–æ</span>
                        {% else %}
                            <span class="notion-badge notion-badge-warning">–ê–∫—Ç–∏–≤–Ω–æ</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if not stat.resolved %}
                        <button class="notion-button" onclick="markResolved({{ stat.id }})">
                            –û—Ç–º–µ—Ç–∏—Ç—å —Ä–µ—à—ë–Ω–Ω—ã–º
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –ª–æ–≥–∞ -->
<div id="logModal" class="notion-modal-overlay" style="display: none;">
    <div class="notion-modal">
        <div class="notion-modal-header">
            <h3>–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏</h3>
            <button class="notion-modal-close" onclick="closeLogModal()">√ó</button>
        </div>
        <div class="notion-modal-body" id="logDetails">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        <div class="notion-modal-footer">
            <button class="notion-button" onclick="closeLogModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const logModal = document.getElementById('logModal');
const logDetails = document.getElementById('logDetails');

function viewLog(logId) {
    fetch(`/admin/logs/${logId}`)
        .then(r => r.json())
        .then(data => {
            let html = `
                <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${data.level}</p>
                <p><strong>–í—Ä–µ–º—è:</strong> ${data.created_at}</p>
                <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${data.source}</p>
                <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${data.user_id || '-'}</p>
                <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${data.message}</p>
            `;
            if (data.traceback) {
                html += `<p><strong>Traceback:</strong></p><pre>${data.traceback}</pre>`;
            }
            if (data.request_data) {
                html += `<p><strong>–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:</strong></p><pre>${JSON.stringify(data.request_data, null, 2)}</pre>`;
            }
            logDetails.innerHTML = html;
            logModal.style.display = 'flex';
        });
}

function closeLogModal() {
    logModal.style.display = 'none';
}

function markResolved(statId) {
    const comment = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ—á–µ–º—É –æ—à–∏–±–∫–∞ —Ä–µ—à–µ–Ω–∞):');
    if (comment === null) return;
    fetch(`/admin/error-stats/${statId}/resolve`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({comment: comment})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('–û—à–∏–±–∫–∞: ' + data.error);
    });
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
window.addEventListener('click', function(e) {
    if (e.target === logModal) closeLogModal();
});
</script>
{% endblock %}