{% extends "base.html" %}

{% block content %}
<div class="notion-page-header">
    <h1>
        <span class="icon">üì¢</span>
        Telegram-–∫–∞–Ω–∞–ª—ã
    </h1>
    <div class="notion-page-description">
        –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –∫–∞–Ω–∞–ª—ã
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-header">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</h2>
    </div>
    <div class="notion-block-body">
        <div class="alert alert-info">
            <strong>–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª:</strong>
            <ol>
                <li>–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ <strong>@{{ bot_username }}</strong> –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∫–∞–Ω–∞–ª–∞</li>
                <li>–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, -1001234567890) –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ</li>
                <li>ID –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –ø–µ—Ä–µ—Å–ª–∞–≤ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ –≤ @getidsbot</li>
            </ol>
        </div>
        <form method="post" action="{{ url_for('channels.add_channel_route') }}" class="form-inline">
            <div class="form-row">
                <input type="text" name="channel_id" placeholder="ID –∫–∞–Ω–∞–ª–∞" class="notion-input" required>
                <input type="text" name="channel_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞" class="notion-input" required>
                <input type="text" name="channel_username" placeholder="@username (–µ—Å–ª–∏ –µ—Å—Ç—å)" class="notion-input">
                <button type="submit" class="notion-button notion-button-primary">
                    <i data-feather="plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-header">
        <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã</h2>
    </div>
    <div class="notion-block-body">
        {% if channels %}
        <table class="notion-table">
            <thead>
                <tr>
                    <th>–ö–∞–Ω–∞–ª</th>
                    <th>ID</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for ch in channels %}
                <tr>
                    <td>
                        <strong>{{ ch.channel_name }}</strong><br>
                        {% if ch.channel_username %}
                            <a href="https://t.me/{{ ch.channel_username[1:] }}" target="_blank">{{ ch.channel_username }}</a>
                        {% endif %}
                    </td>
                    <td><code>{{ ch.channel_id }}</code></td>
                    <td>
                        {% if ch.is_active %}
                            <span class="notion-badge notion-badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                            <span class="notion-badge">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="notion-button" onclick="showSettings({{ ch.id }})">
                            <i data-feather="settings"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                        </button>
                    </td>
                    <td class="actions">
                        <a href="{{ url_for('channels.toggle_channel', channel_id=ch.id) }}" class="notion-button">
                            {% if ch.is_active %}
                                <i data-feather="pause-circle"></i> –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                            {% else %}
                                <i data-feather="play-circle"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                            {% endif %}
                        </a>
                        <form method="post" action="{{ url_for('channels.delete_channel_route', channel_id=ch.id) }}" style="display:inline;">
                            <button type="submit" class="notion-button" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª?')">
                                <i data-feather="trash-2"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                <tr id="settings-{{ ch.id }}" style="display: none;">
                    <td colspan="5">
                        <form method="post" action="{{ url_for('channels.update_channel_settings', channel_id=ch.id) }}" class="settings-form">
                            <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h4>
                            <table class="notion-table">
                                <thead>
                                    <tr>
                                        <th>–°–æ–±—ã—Ç–∏–µ</th>
                                        <th>–í–∫–ª—é—á–µ–Ω–æ</th>
                                        <th>–®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for setting in ch.settings %}
                                    <tr>
                                        <td>
                                            {% if setting.event_type == 'new_appointment' %}üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å
                                            {% elif setting.event_type == 'new_review' %}‚≠ê –ù–æ–≤—ã–π –æ—Ç–∑—ã–≤
                                            {% elif setting.event_type == 'appointment_confirmed' %}‚úÖ –ó–∞–ø–∏—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
                                            {% elif setting.event_type == 'appointment_cancelled' %}‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞
                                            {% elif setting.event_type == 'completed_appointment' %}üéâ –£—Å–ª—É–≥–∞ –æ–∫–∞–∑–∞–Ω–∞
                                            {% else %}{{ setting.event_type }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <input type="checkbox" name="enabled_{{ setting.event_type }}" {% if setting.is_enabled %}checked{% endif %}>
                                        </td>
                                        <td>
                                            <textarea name="template_{{ setting.event_type }}" rows="2" class="notion-input">{{ setting.message_template }}</textarea>
                                            <small class="hint">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {client_name}, {service_name}, {date}, {time}, {rating}, {review_text}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <button type="submit" class="notion-button notion-button-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">–ö–∞–Ω–∞–ª—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã</p>
        {% endif %}
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-header">
        <h2>–ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π</h2>
    </div>
    <div class="notion-block-body">
        <table class="notion-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–ö–∞–Ω–∞–ª</th>
                    <th>–°–æ–±—ã—Ç–∏–µ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts_history %}
                <tr>
                    <td>{{ post.published_at|datetime }}</td>
                    <td>{{ post.channel_name }}</td>
                    <td>{{ post.event_type }}</td>
                    <td>
                        {% if post.status == 'success' %}
                            <span class="notion-badge notion-badge-success">–£—Å–ø–µ—à–Ω–æ</span>
                        {% else %}
                            <span class="notion-badge notion-badge-danger">–û—à–∏–±–∫–∞</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function showSettings(channelId) {
    const row = document.getElementById(`settings-${channelId}`);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}
</script>
{% endblock %}