{% extends "base.html" %}

{% block content %}
<div class="notion-page-header">
    <h1>
        <span class="icon">üíæ</span>
        –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    </h1>
    <div class="notion-page-description">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∫–∞–ø–∞–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-header">
        <h2>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</h2>
    </div>
    <div class="notion-block-body">
        <button id="createBackupBtn" class="notion-button notion-button-primary">
            <i data-feather="database"></i> –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        </button>
        <p class="hint">–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ø–∞–ø–∫–µ backups/. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±–µ–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00.</p>
    </div>
</div>

<div class="notion-block">
    <div class="notion-block-header">
        <h2>–°–ø–∏—Å–æ–∫ –±–µ–∫–∞–ø–æ–≤</h2>
    </div>
    <div class="notion-block-body">
        {% if backups %}
        <table class="notion-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–¢–∏–ø</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for backup in backups %}
                <tr>
                    <td>{{ backup.id }}</td>
                    <td>{{ backup.created_at|datetime }}</td>
                    <td><code>{{ backup.filename }}</code></td>
                    <td>{{ backup.filesize }}</td>
                    <td>
                        {% if backup.type == 'automatic' %}
                            <span class="notion-badge">–ê–≤—Ç–æ</span>
                        {% else %}
                            <span class="notion-badge notion-badge-success">–†—É—á–Ω–æ–π</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if backup.status == 'completed' %}
                            <span class="notion-badge notion-badge-success">–£—Å–ø–µ—à–Ω–æ</span>
                        {% elif backup.status == 'failed' %}
                            <span class="notion-badge notion-badge-danger">–û—à–∏–±–∫–∞</span>
                        {% else %}
                            <span class="notion-badge notion-badge-warning">{{ backup.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ backup.comment or '‚Äî' }}</td>
                    <td>
                        {% if backup.restored_at %}
                            {{ backup.restored_at|datetime }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td class="actions">
                        <button class="notion-button" onclick="restoreBackup({{ backup.id }})" {% if backup.status != 'completed' %}disabled{% endif %}>
                            <i data-feather="rotate-ccw"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="notion-button" onclick="deleteBackup({{ backup.id }})">
                            <i data-feather="trash-2"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">–ë–µ–∫–∞–ø–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('createBackupBtn').addEventListener('click', function() {
    if (!confirm('–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) return;
    fetch('/admin/backups/create', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ë–µ–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(e => alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'));
});

function restoreBackup(backupId) {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±–µ–∫–∞–ø–∞ –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    fetch(`/admin/backups/${backupId}/restore`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        });
}

function deleteBackup(backupId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –±–µ–∫–∞–ø–∞?')) return;
    fetch(`/admin/backups/${backupId}/delete`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) location.reload();
            else alert('–û—à–∏–±–∫–∞: ' + (data.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
}
</script>
{% endblock %}