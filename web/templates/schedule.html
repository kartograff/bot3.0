{% extends "base.html" %}

{% block content %}
<div class="notion-page-header">
    <h1>
        <span class="icon">üìÜ</span>
        –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π
    </h1>
    <div class="notion-page-description">
        –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏ –ø–æ –¥–∞—Ç–∞–º
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
<div class="calendar-nav">
    <button class="notion-button" onclick="changeMonth(-1)">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
    <h2 id="currentMonthDisplay">{{ current_month }}</h2>
    <button class="notion-button" onclick="changeMonth(1)">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
<div class="notion-calendar" id="calendarGrid"></div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É -->
<div class="notion-block" id="appointmentsBlock" style="display: none;">
    <div class="notion-block-header">
        <h2>–ó–∞–ø–∏—Å–∏ –Ω–∞ <span id="selectedDate"></span></h2>
    </div>
    <div class="notion-block-body" id="appointmentsList">
        <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentDate = new Date();

function renderCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // –ü–Ω = 0
    const daysInMonth = lastDay.getDate();

    let html = '<div class="notion-calendar-weekdays">';
    const weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    weekdays.forEach(day => html += `<div class="notion-calendar-weekday">${day}</div>`);
    html += '</div><div class="notion-calendar-grid">';

    // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–Ω—ë–º
    for (let i = 0; i < startDayOfWeek; i++) {
        html += '<div class="notion-calendar-day empty"></div>';
    }

    // –î–Ω–∏ –º–µ—Å—è—Ü–∞
    const today = new Date();
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
        html += `<div class="notion-calendar-day ${isToday ? 'today' : ''}" data-date="${dateStr}">${d}</div>`;
    }

    html += '</div>';
    document.getElementById('calendarGrid').innerHTML = html;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –¥–Ω–∏
    document.querySelectorAll('.notion-calendar-day[data-date]').forEach(day => {
        day.addEventListener('click', function() {
            const date = this.dataset.date;
            loadAppointments(date);
        });
    });

    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –¥–Ω–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º)
    fetch(`/api/appointments/dates?year=${year}&month=${month+1}`)
        .then(r => r.json())
        .then(dates => {
            dates.forEach(date => {
                const dayElem = document.querySelector(`.notion-calendar-day[data-date="${date}"]`);
                if (dayElem) dayElem.classList.add('has-appointments');
            });
        });
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    document.getElementById('appointmentsBlock').style.display = 'none';
}

function loadAppointments(date) {
    document.getElementById('selectedDate').textContent = date;
    fetch(`/appointments_by_date/${date}`)
        .then(r => r.json())
        .then(appointments => {
            const list = document.getElementById('appointmentsList');
            if (appointments.length === 0) {
                list.innerHTML = '<p class="empty-state">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</p>';
            } else {
                let html = '<table class="notion-table"><thead><tr><th>–í—Ä–µ–º—è</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–£—Å–ª—É–≥–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
                appointments.forEach(apt => {
                    html += `<tr>
                        <td>${apt.time}</td>
                        <td>${apt.client_name}</td>
                        <td>${apt.service}</td>
                        <td>${getStatusBadge(apt.status)}</td>
                        <td>
                            <button class="notion-button" onclick="viewAppointment(${apt.id})">
                                <i data-feather="eye"></i>
                            </button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
                feather.replace();
            }
            document.getElementById('appointmentsBlock').style.display = 'block';
        });
}

function getStatusBadge(status) {
    switch(status) {
        case 'confirmed': return '<span class="notion-badge notion-badge-success">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>';
        case 'pending': return '<span class="notion-badge notion-badge-warning">–û–∂–∏–¥–∞–µ—Ç</span>';
        case 'cancelled': return '<span class="notion-badge notion-badge-danger">–û—Ç–º–µ–Ω–µ–Ω–æ</span>';
        default: return status;
    }
}

function viewAppointment(id) {
    window.location.href = `/appointments/${id}`;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
    document.getElementById('currentMonthDisplay').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
});
</script>

<style>
.calendar-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
}
.notion-calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--notion-text-light);
}
.notion-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}
.notion-calendar-day {
    aspect-ratio: 1;
    padding: 8px;
    background: var(--notion-bg-secondary);
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.1s ease;
}
.notion-calendar-day:hover {
    background-color: var(--notion-bg-hover);
}
.notion-calendar-day.today {
    border: 2px solid var(--notion-accent);
}
.notion-calendar-day.has-appointments {
    font-weight: 600;
    position: relative;
}
.notion-calendar-day.has-appointments::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: var(--notion-accent);
    border-radius: 50%;
}
.notion-calendar-day.empty {
    background: none;
    cursor: default;
}
#appointmentsBlock {
    margin-top: 24px;
}
</style>
{% endblock %}