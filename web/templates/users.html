{% extends "base.html" %}

{% block content %}
<div class="notion-page-header">
    <h1>
        <span class="icon">üë•</span>
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    </h1>
    <div class="notion-page-description">
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ -->
<div class="notion-block filters-block">
    <div class="notion-block-body">
        <form method="get" class="filters-form">
            <div class="filter-group">
                <label class="notion-label">–ü–æ–∏—Å–∫</label>
                <input type="text" name="search" value="{{ search }}" placeholder="–ò–º—è, username, —Ç–µ–ª–µ—Ñ–æ–Ω..." class="notion-input">
            </div>
            <div class="filter-actions">
                <button type="submit" class="notion-button notion-button-primary">
                    <i data-feather="search"></i> –ù–∞–π—Ç–∏
                </button>
                <a href="{{ url_for('users.users_list') }}" class="notion-button">
                    <i data-feather="x"></i> –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div class="notion-block">
    <div class="notion-block-header">
        <h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
    </div>
    <div class="notion-block-body">
        {% if users %}
        <table class="notion-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.user_id }}</td>
                    <td>@{{ user.username or '‚Äî' }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.phone or '‚Äî' }}</td>
                    <td class="note-cell">
                        <span class="note-text" id="note-{{ user.user_id }}">{{ user.notes or '' }}</span>
                        <button class="edit-note-btn" data-user-id="{{ user.user_id }}" onclick="editNote({{ user.user_id }})">
                            <i data-feather="edit-2" width="14" height="14"></i>
                        </button>
                    </td>
                    <td class="actions">
                        <a href="{{ url_for('users.user_detail', user_id=user.user_id) }}" class="notion-button">
                            <i data-feather="eye"></i>
                        </a>
                        <button class="notion-button" onclick="deleteUser({{ user.user_id }})">
                            <i data-feather="trash-2"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, total_pages + 1) %}
                <a href="{{ url_for('users.users_list', page=p, search=search) }}" 
                   class="notion-button {% if p == page %}notion-button-primary{% endif %}">
                    {{ p }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
        {% else %}
        <p class="empty-state">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ -->
<div id="noteModal" class="notion-modal-overlay" style="display: none;">
    <div class="notion-modal">
        <div class="notion-modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
            <button class="notion-modal-close" onclick="closeNoteModal()">√ó</button>
        </div>
        <div class="notion-modal-body">
            <textarea id="noteInput" rows="5" class="notion-input" style="width: 100%;"></textarea>
        </div>
        <div class="notion-modal-footer">
            <button class="notion-button" onclick="closeNoteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="notion-button notion-button-primary" onclick="saveNote()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentUserId = null;
const noteModal = document.getElementById('noteModal');
const noteInput = document.getElementById('noteInput');

function editNote(userId) {
    currentUserId = userId;
    const noteText = document.getElementById(`note-${userId}`).innerText;
    noteInput.value = noteText;
    noteModal.style.display = 'flex';
}

function closeNoteModal() {
    noteModal.style.display = 'none';
    currentUserId = null;
}

function saveNote() {
    if (!currentUserId) return;
    const newNote = noteInput.value.trim();
    fetch(`/users/${currentUserId}/note`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ note: newNote })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById(`note-${currentUserId}`).innerText = newNote;
            closeNoteModal();
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    });
}

function deleteUser(userId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        fetch(`/users/${userId}`, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            });
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
window.addEventListener('click', function(e) {
    if (e.target === noteModal) closeNoteModal();
});
</script>
{% endblock %}